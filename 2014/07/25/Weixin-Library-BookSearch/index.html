<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5">


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.2">


    <meta name="description" content="醉后不知天在水,围着火炉吃西瓜">



  <meta name="keywords" content="PHP,QRcode,图书馆,开发,微信公众平台,模拟登入,笔记,编码,验证码,">



  <link rel="alternate" href="/atom.xml" title="格物志" type="application/atom+xml">



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.png?v=0.4.2">



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?71aa842f083e84e236b454b1cbee2581";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <title> 微信公众平台图书馆查询开发记录 // 格物志 </title>
</head>

<body>
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">格物志</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br>
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br>
          分类
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br>
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br>
          标签
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br>
          关于
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              微信公众平台图书馆查询开发记录
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2014-07-24
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/微信平台开发记录/">微信平台开发记录</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/07/25/Weixin-Library-BookSearch/#comments">
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/25/Weixin-Library-BookSearch/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <p><strong>摘要</strong>：这篇文章记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode转UTF-8编码过程（5）微信公众账号的绑定（6）Memcache缓存技术(7)正则表达式<br><a id="more"></a><br>这是一篇记录我的第一个微信应用——福建农林大学图书馆服务的开发记录，应用架设在Sina App Engine,开发目标是解决手机登入web查看图书不便的问题，并提供响应的服务功能，比如（1）图书5天内图书到期的提醒（2）图书的查询服务（3）图书借阅的查询服务（4）暂时图书馆没有藏书的到书提醒（5）免验证码登陆，算是对自己多天折腾的总结并提供有相关需求的朋友一些思路。</p>
<h1 id="Fidder2解析图书馆登入系统过程">Fidder2解析图书馆登入系统过程</h1><h2 id="Fidder2介绍">Fidder2介绍</h2><blockquote>
<p>Fiddler是一个http协议调试代理工具，它能够记录并检查所有你的电脑和互联网之间的http通讯，设置断点，查看所有的“进出”Fiddler的数据（指cookie,html,js,css等文件，这些都可以让你胡乱修改的意思）。 Fiddler 要比其他的网络调试器要更加简单，因为它不仅仅暴露http通讯还提供了一个用户友好的格式。</p>
</blockquote>
<p>利用Fidder可以方便的从数据连接中扒取链接的信息，即使是表单是通过_POST，我们也能够很方便的从数据流中截取用户发送的信息，从而将机器伪装成人肉对服务器进行请求，实现模拟登入。</p>
<h2 id="通过Fidder查看图书馆登入过程">通过Fidder查看图书馆登入过程</h2><p>首先，打开Fidder，开始对通信进行监听，登入我们的目标站点——福建农林大学图书馆的登入页面<code>http://210.34.85.114:8080/reader/login.php</code>,输入学号，密码和验证码（正不正确不重要，这里主要查看数据的发送格式），选择<code>证件号</code>，点击<code>登入</code>，打开Fidder，选择验证服务器的url<code>http://210.34.85.114:8080/reader/redr_verify.php</code>，在<code>Inspectors下的Raw标签</code>下可以看到发送的信息，如下</p>
<pre><code><span class="request">POST <span class="string">http://210.34.85.114:8080/reader/redr_verify.php</span> HTTP/1.1</span>
<span class="attribute">Host</span>: <span class="string">210.34.85.114:8080</span>
<span class="attribute">User-Agent</span>: <span class="string">Mozilla/5.0 (Windows NT 6.3; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0</span>
<span class="attribute">Accept</span>: <span class="string">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="attribute">Accept-Language</span>: <span class="string">zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3</span>
<span class="attribute">Accept-Encoding</span>: <span class="string">gzip, deflate</span>
<span class="attribute">Referer</span>: <span class="string">http://210.34.85.114:8080/reader/login.php</span>
<span class="attribute">Cookie</span>: <span class="string">PHPSESSID=ordh88pv46g9jco23d32pvqer3</span>
<span class="attribute">Connection</span>: <span class="string">keep-alive</span>
<span class="attribute">Content-Type</span>: <span class="string">application/x-www-form-urlencoded</span>
<span class="attribute">Content-Length</span>: <span class="string">70</span>

<span class="nix"><span class="variable">number=</span><span class="number">3125002076</span>&amp;<span class="variable">passwd=</span><span class="number">147</span>qj9&amp;<span class="variable">captcha=</span><span class="number">1173</span>&amp;<span class="variable">select=</span>cert_no&amp;<span class="variable">returnUrl=</span></span>
</code></pre><p>发送的目标地址</p>
<pre><code><span class="constant">POST </span><span class="symbol">http:</span>/<span class="regexp">/210.34.85.114:8080/reader</span><span class="regexp">/redr_verify.php HTTP/</span><span class="number">1.1</span>
</code></pre><p>用户进行浏览器的头文件为：</p>
<pre><code><span class="attribute">User-Agent</span>: <span class="string">Mozilla/5.0 (Windows NT 6.3; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0</span>
<span class="attribute">Accept</span>: <span class="string">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="attribute">Accept-Language</span>: <span class="string">zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3</span>
<span class="attribute">Accept-Encoding</span>: <span class="string">gzip, deflate</span>
</code></pre><p>用户发送的信息格式为：</p>
<pre><code><span class="variable">number=</span><span class="number">3125002076</span>&amp;<span class="variable">passwd=</span><span class="number">147</span>qj9&amp;<span class="variable">captcha=</span><span class="number">1173</span>&amp;<span class="variable">select=</span>cert_no&amp;<span class="variable">returnUrl=</span>
</code></pre><p>后头我们将对这些信息进行封装，通过curl POST至目标地址<code>http://210.34.85.114:8080/reader/redr_verify.php HTTP/1.1</code>。<br>由于本文涉及到验证码的机器识别，所以我们还需要获取生成验证码的服务器地址，Fidder中我们可以找到生成验证码的url<code>http://210.34.85.114:8080/reader/captcha.php</code>，返回数据格式为<code>captcha.gif</code></p>
<h1 id="模拟图书馆登入系统过程">模拟图书馆登入系统过程</h1><pre><code>//*-----------------------------------WXLibSearch.php--------------------------------------*//
<span class="php"><span class="preprocessor">&lt;?php</span>
<span class="keyword">include</span> (<span class="string">'Valite.php'</span>);    <span class="comment">//验证码识别类</span>
<span class="keyword">include</span> (<span class="string">'u2utf82gb.php'</span>);    <span class="comment">//NCR转GB2312类</span>
<span class="comment">//获取用户键入的信息</span>
<span class="function"><span class="keyword">function</span> <span class="title">getborrowedbookinfo</span> <span class="params">(<span class="variable">$keyword</span>)</span></span>{

    <span class="comment">/*
    *正则表达式检测用户输入信息是否为"学号（10位）+密码"
    *如果是则进行模拟登入获取借阅信息
    *如果输入错误则返回"请按照格式输入学号和密码"
    */</span>

    <span class="keyword">if</span> (preg_match_all(<span class="string">"/^(\d{10})\+\S+/"</span>,<span class="variable">$keyword</span>,<span class="variable">$info</span><span class="string">")){

        //切割字符串，学号为前10位（0-9），密码为第11后（10-）
        $num=substr($info,0,9);    //学号
        $pass=substr($info,11);    //密码


        //获取验证码url
        $url = "</span>http:<span class="comment">//210.34.85.114:8080/reader/captcha.php";</span>
        <span class="comment">//保存cookie在当前路径下的"valid.tmp"文件之中，跨页面传递用户信息</span>
        <span class="variable">$cookie</span> = dirname(<span class="keyword">__FILE__</span>).<span class="string">"/valid.tmp"</span>;

        <span class="comment">//curl访问验证码图片网址，把返回的cookie保存为valid.tmp文件</span>
        <span class="variable">$curl</span> = curl_init(<span class="variable">$url</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);    <span class="comment">//设定返回 的数据是否自动显示</span>
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_COOKIEFILE, <span class="variable">$cookie</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_COOKIEJAR, <span class="variable">$cookie</span>);    <span class="comment">// 把返回来的cookie信息保存在$cookie文件中</span>
        <span class="variable">$data</span> = curl_exec(<span class="variable">$curl</span>);
        curl_close(<span class="variable">$curl</span>);

        <span class="comment">//保存验证码图片</span>
        <span class="variable">$fp</span> = fopen(<span class="string">"valid.gif"</span>,<span class="string">"wb"</span>);
        fwrite(<span class="variable">$fp</span>, <span class="variable">$data</span>);
        fclose(<span class="variable">$fp</span>); 

        <span class="comment">//识别验证码图片</span>
        <span class="variable">$valid</span> = <span class="keyword">new</span> Valite();
        <span class="variable">$valid</span>-&gt;setImage(<span class="string">"valid.gif"</span>);
        <span class="variable">$valid</span>-&gt;getHec();
        <span class="variable">$validCode</span> = <span class="variable">$valid</span>-&gt;run();


        <span class="comment">//组装数据</span>
        <span class="variable">$data</span> = <span class="string">"number="</span>.<span class="variable">$num</span>.<span class="string">"&amp;passwd="</span>.<span class="variable">$pass</span>.<span class="string">"&amp;captcha="</span>.<span class="variable">$validCode</span>.<span class="string">"&amp;select=cert_no&amp;returnUrl="</span>;
        <span class="comment">//头文件</span>
        <span class="variable">$headers</span> = <span class="keyword">array</span>(
            <span class="string">"User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0"</span>,<span class="string">"Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>,
            <span class="string">"Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3"</span>,
            <span class="string">"Accept-Encoding: gzip, deflate"</span>,
            );

        <span class="comment">//curl发送数据进行登陆</span>
        <span class="variable">$url</span> = <span class="string">"http://210.34.85.114:8080/reader/redr_verify.php"</span>;
        <span class="variable">$curl</span> = curl_init();
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_HTTPHEADER, <span class="variable">$headers</span>);    /设定是否显示头信息
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_COOKIEFILE, <span class="variable">$cookie</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_POST, <span class="number">1</span>);
        curl_setopt(<span class="variable">$curl</span>,CURLOPT_POSTFIELDS,<span class="variable">$data</span>);
        <span class="variable">$src</span> = curl_exec(<span class="variable">$curl</span>);
        curl_close(<span class="variable">$curl</span>);

        <span class="comment">//利用cookie进行借阅图书查询</span>
        <span class="variable">$url</span> = <span class="string">"http://210.34.85.114:8080/reader/book_lst.php"</span>;
        <span class="variable">$curl</span> = curl_init();
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_HTTPHEADER, <span class="variable">$headers</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);
        curl_setopt(<span class="variable">$curl</span>, CURLOPT_COOKIEFILE, <span class="variable">$cookie</span>);
        <span class="variable">$src</span> = curl_exec(<span class="variable">$curl</span>);
        curl_close(<span class="variable">$curl</span>);

        <span class="comment">//截取出html中的书名</span>

        <span class="variable">$booknum</span> = preg_match_all(<span class="string">'/&lt;a[^&gt;]+&gt;\S+&lt;\/a&gt;/'</span>,<span class="variable">$src</span>,<span class="variable">$bookinfo</span>);
        <span class="variable">$hadborrowed</span> = <span class="variable">$booknum</span>-<span class="number">23</span>;    <span class="comment">//当前借阅量</span>
        <span class="variable">$bookborrowed</span> = <span class="string">"当前借阅量：$hadborrowed"</span>;
        <span class="variable">$bookborrowed</span> = iconv(<span class="string">'UTF-8'</span>, <span class="string">'GB2312'</span>, <span class="variable">$bookborrowed</span>);
        <span class="variable">$books</span> = <span class="string">""</span>;    <span class="comment">//建立容器储存书名</span>
        <span class="variable">$n</span> = <span class="number">0</span>;    <span class="comment">//用于为标题名前加上标号</span>
        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">23</span>;<span class="variable">$i</span>&lt;<span class="variable">$booknum</span>;<span class="variable">$i</span>++){
        <span class="variable">$n</span> = <span class="variable">$n</span>+<span class="number">1</span>;    
        <span class="variable">$str1</span> = <span class="string">""</span>;    <span class="comment">//建立容器用于储存转化为GB2312的字符，每循环一次数据清空，储存到$books容器之中</span>
            <span class="comment">//unicode转化为utf-8</span>
            <span class="comment">//通过explode，标记为";"将字符串切割成单个Uincode编码字符</span>
            <span class="variable">$bookinf</span> = explode(<span class="string">';'</span>,<span class="variable">$bookinfo</span>[<span class="number">0</span>][<span class="variable">$i</span>]);
            <span class="keyword">foreach</span>(<span class="variable">$bookinf</span> <span class="keyword">as</span> <span class="variable">$bookinfx</span>){    <span class="comment">//遍历字符串字符进行转码</span>
                <span class="variable">$bookinfx</span> = preg_replace(<span class="string">'/&lt;[^&gt;]+&gt;/'</span>,<span class="string">''</span>,<span class="variable">$bookinfx</span>);    <span class="comment">//除去头尾字符的html标签</span>
                <span class="variable">$code</span> = substr(<span class="variable">$bookinfx</span>,<span class="number">3</span>);    <span class="comment">//除去16位NCR编码的表示部分"&amp;#x"</span>
                <span class="variable">$unicode</span> = hexdec(<span class="variable">$code</span>);    <span class="comment">//16进制转化我10进制</span>
                <span class="variable">$string</span> = u2utf82gb(<span class="variable">$unicode</span>);    <span class="comment">//Unicode转GB2312</span>
                <span class="variable">$str1</span> = <span class="variable">$str1</span>.<span class="variable">$string</span>;    <span class="comment">//将转码后的单个字符拼接起来</span>
            }
            <span class="variable">$books</span> = <span class="variable">$books</span>.<span class="variable">$n</span>.<span class="string">"."</span>.<span class="variable">$str1</span>;    <span class="comment">//将每个书名拼接起来并加上标号"$n."</span>
        }

        <span class="keyword">echo</span> <span class="variable">$bookborrowed</span>.<span class="string">"\n"</span>.<span class="variable">$books</span>;    <span class="comment">//输出借阅的图书量加上书名输出测试</span>
    }
}

<span class="preprocessor">?&gt;</span></span>
</code></pre><h2 id="机器识别验证码">机器识别验证码</h2><p>验证码识别一般分为以下几个步骤：<br>一、取出字模<br>识别验证码，毕竟不是专业的OCR识别，并且，由于各个网站的验证码各不相同，所以，最常见的方法就是就是建立这个验证码的特征码库。去字模时，我们需要多下载几张图片，使这些图片中，包括所有的字符，我们这里的图片里只有数字，所以，只要收集到包括0-9的数字图片即可。</p>
<p>1、多刷新几次验证码，将验证码图片保存起来，要搜集齐0-9的图片，这里我收集了4张验证码才凑齐0~9 10位数字。</p>
<p><img src="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%812.JPG" alt="验证码" title="验证码"></p>
<p>2、用图片处理软件打开图片，我用的是Photoshop，按住ctrl+可以将图片的视图放大，这样就能很清楚地观察到图片的每个像素。</p>
<p><img src="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%813.JPG" alt="放大后的验证码" title="放大后的验证码"></p>
<p>可以发现，每个数字的宽是8px，高是10px，数字的间隔是4px，第一个数字左边偏移了6px，顶部偏移了16px。这些数字后面都是要用到的。<br>3、将每个数字截出来保存为图片，大小为8*10（虽然数字1的宽只占了7个像素，但是还是要截取8个像素的宽度）。</p>
<p>二、图片二值化<br>二值化就是把图片上的验证数字上每个象素用数字1表示，其它部分用0表示。把要识别的图片，进行二值化，将数据保存到二维数组里，得到图片特征数组。</p>
<p>1、首先要将数字和背景色和干扰色区分开来，用屏幕取色器观察颜色的规律。<br>可以得出一个结论：背景颜色的R、G、B值都是大于200的，而数字的颜色的R、G、B值的某一项有小于200，因此可以很容易区分。</p>
<p>2、下面的php代码只是为了演示二维数组，为了直观看出数字，所以把1和0改为了0和-：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;&lt;img src="captcha.gif"&gt;&lt;br&gt;&lt;br&gt;'</span>;</span><br><span class="line"> </span><br><span class="line">getHec(<span class="string">"captcha.gif"</span>);	<span class="comment">//"captcha.gif"中的值为8690</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHec</span><span class="params">(<span class="variable">$imagePath</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$res</span> = imagecreatefromjpeg(<span class="variable">$imagePath</span>);</span><br><span class="line">    <span class="variable">$size</span> = getimagesize(<span class="variable">$imagePath</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$size</span>[<span class="number">1</span>]; ++<span class="variable">$i</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$size</span>[<span class="number">0</span>]; ++<span class="variable">$j</span>) &#123;</span><br><span class="line">            <span class="variable">$rgb</span> = imagecolorat(<span class="variable">$res</span>, <span class="variable">$j</span>, <span class="variable">$i</span>);</span><br><span class="line">            <span class="variable">$rgbarray</span> = imagecolorsforindex(<span class="variable">$res</span>, <span class="variable">$rgb</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$rgbarray</span>[<span class="string">'red'</span>] &lt; <span class="number">200</span> || <span class="variable">$rgbarray</span>[<span class="string">'green'</span>]&lt;<span class="number">200</span> || <span class="variable">$rgbarray</span>[<span class="string">'blue'</span>] &lt; <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"0"</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"-"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">```   </span><br><span class="line">二值化的结果如下图所示：</span><br></pre></td></tr></table></figure></p>
<h2 id="——————————————————————————————">——————————————————————————————</h2><h2 id="——————————————————————————————-1">——————————————————————————————</h2><h2 id="——————————————————————————————-2">——————————————————————————————</h2><h2 id="——————————————————————————————-3">——————————————————————————————</h2><h2 id="——————————————————————————————-4">——————————————————————————————</h2><h2 id="——————————————————————————————-5">——————————————————————————————</h2><h2 id="——————————————————————————————-6">——————————————————————————————</h2><h2 id="——————————————————————————————-7">——————————————————————————————</h2><p>————0000————0000————0000————-00——————-<br>———-00—00———00—00———00—00———-0000——————<br>———00——00——00——0——-00——00——-00—00—————-<br>———-00—00——-00—————00——00——00——00—————<br>————0000———00-000———-00—000——00——00—————<br>———-00—00——-000—00———-000-00——00——00—————<br>———00——00——00——00—————00——00——00—————<br>———00——00——00——00——-0——00——-00—00—————-<br>———-00—00———00—00———00—00———-0000——————</p>
<h2 id="————0000————0000————0000————-00——————-">————0000————0000————0000————-00——————-</h2><h2 id="——————————————————————————————-8">——————————————————————————————</h2><h2 id="——————————————————————————————-9">——————————————————————————————</h2><h2 id="——————————————————————————————-10">——————————————————————————————</h2><h2 id="——————————————————————————————-11">——————————————————————————————</h2><hr>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">如果图片的背景颜色比较复杂，处理方法也是一样的，总能找到临界值来区分，具体要靠自己观察了。</span><br><span class="line"></span><br><span class="line">三、数字字模二值化</span><br><span class="line">计算出每个数字字模的二值化的数据，记录下这些数据，当作<span class="variable">key</span>即可。</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、将<span class="number">0</span>-<span class="number">9</span>的数字字模图片进行二值化，逐个取出图片的像个像素的颜色，然后获取每个像素的R、G、B值，再进行判断，代码如下：</span><br></pre></td></tr></table></figure>
<p>for ($i = 0; $i &lt; 10; $i++) {<br>    echo “‘$i’=&gt;’”;<br>    echo getHec(“$i.jpg”).”‘,<br>“;<br>}</p>
<p>function getHec($imagePath) {<br>    $res = imagecreatefromjpeg($imagePath);<br>    $size = getimagesize($imagePath);</p>
<pre><code><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$size</span>[<span class="number">1</span>]; ++<span class="variable">$i</span>) {
    <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$size</span>[<span class="number">0</span>]; ++<span class="variable">$j</span>) {
        <span class="variable">$rgb</span> = imagecolorat(<span class="variable">$res</span>, <span class="variable">$j</span>, <span class="variable">$i</span>);
        <span class="variable">$rgbarray</span> = imagecolorsforindex(<span class="variable">$res</span>, <span class="variable">$rgb</span>);
        <span class="keyword">if</span> (<span class="variable">$rgbarray</span>[<span class="string">'red'</span>] &lt; <span class="number">200</span> || <span class="variable">$rgbarray</span>[<span class="string">'green'</span>]&lt;<span class="number">200</span> || <span class="variable">$rgbarray</span>[<span class="string">'blue'</span>] &lt; <span class="number">200</span>) {
            <span class="built_in">echo</span> <span class="string">"1"</span>;
        }<span class="keyword">else</span>{
            <span class="built_in">echo</span> <span class="string">"0"</span>;
        }
    }
}
</code></pre><p>}<br>输出结果：<br>‘0’ =&gt; ‘011110100001100001100001100001100001100001100001100001011110’,<br>‘1’ =&gt; ‘001000111000001000001000001000001000001000001000001000111110’,<br>‘2’ =&gt; ‘011110100001100001000001000010000100001000010000110011111111’,<br>‘3’ =&gt; ‘011110100001100001000010001100000010000001100001100001011110’,<br>‘4’ =&gt; ‘000100000100001100010100100100100100111111000100001100001111’,<br>‘5’ =&gt; ‘111111100000100000101110110001000001000001100001100001011110’,<br>‘6’ =&gt; ‘001110010001100000100000101110110001100001100001100001011110’,<br>‘7’ =&gt; ‘111111100010100010000100000100001000001000001000001000001000’,<br>‘8’ =&gt; ‘011110100001100001100001011110010010100001100001100001011110’,<br>‘9’ =&gt; ‘011100100010100001100001100011011101000001000001100010011100’,<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">四、对照样本</span><br><span class="line">把步骤二中的图片特征码和步骤三中的验证码的字模进行对比，得到验证图片上的数字。</span><br><span class="line">算法过程：</span><br><span class="line"></span><br><span class="line">1、将图片二值化后的值保存到二维数组里。</span><br><span class="line"></span><br><span class="line">2、通过循环，求出每一个数字的位置，要用到前面得到的数字的宽、高、间隔、左边偏移、顶部偏移。</span><br><span class="line">例如：第i个数字左边偏移 =（数字宽 + 间隔）* i + 左边偏移。</span><br><span class="line"></span><br><span class="line">3、知道了数字的偏移位置，就可以计算出数字在二维数组里的位置，通过循环将数字的6*10=60个数据取出来拼接在一起，就形成了与数字字模类似的字符串。</span><br><span class="line"></span><br><span class="line">4、将字符串与每一个字模的字符串比较，求其相似度，取最高的相似度对应的数字，或者相似度达到95%以上就可以断定是某个数字。</span><br><span class="line"></span><br><span class="line">5、识别结果如下：</span><br><span class="line"></span><br><span class="line">![识别结果](http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%814.JPG "识别结果")</span><br><span class="line"></span><br><span class="line">使用目前这种方法，对验证码的识别基本上可以做到100%。</span><br><span class="line">通过以上步骤，您可能说了，并没有发现如何取出干扰素啊！其实取出干扰素的方法很简单，干扰素的一个重要特征是，不能影响验证码的显示效果，所以制作干扰素时它的RGB可能低于或者高于某个特定值，比如我给的例子中的图片，干扰素的RGB各项值是不会小于200的，所以，这样我们就很容易去掉干扰素了。</span><br><span class="line">	</span><br><span class="line">	//*-----------------------------------Valite.php--------------------------------------*//</span><br><span class="line">	<span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line">	</span><br><span class="line">	define(<span class="string">'WORD_WIDTH'</span>,<span class="number">8</span>);	<span class="comment">//定义每个字符的高度</span></span><br><span class="line">	define(<span class="string">'WORD_HIGHT'</span>,<span class="number">10</span>);	<span class="comment">//定义每个字的宽度</span></span><br><span class="line">	define(<span class="string">'OFFSET_X'</span>,<span class="number">6</span>);	<span class="comment">//左偏移的像素数</span></span><br><span class="line">	define(<span class="string">'OFFSET_Y'</span>,<span class="number">16</span>);	<span class="comment">//高偏移的像素数</span></span><br><span class="line">	define(<span class="string">'WORD_SPACING'</span>,<span class="number">4</span>);	<span class="comment">//字符间的像素数</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">valite</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setImage</span><span class="params">(<span class="variable">$Image</span>)</span>	//打开二维码图片</span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="variable">$this</span>-&gt;ImagePath = <span class="variable">$Image</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">()</span></span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span><span class="params">()</span></span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$DataArray</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHec</span><span class="params">()</span>	//除去干扰像素的方法</span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="variable">$res</span> = imagecreatefromgif(<span class="variable">$this</span>-&gt;ImagePath);		<span class="comment">//创建图像</span></span><br><span class="line">			<span class="variable">$size</span> = getimagesize(<span class="variable">$this</span>-&gt;ImagePath);	<span class="comment">//获取图像长宽</span></span><br><span class="line">			<span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">			<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$size</span>[<span class="number">1</span>]; ++<span class="variable">$i</span>)	<span class="comment">//循环遍历宽度</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$size</span>[<span class="number">0</span>]; ++<span class="variable">$j</span>)	<span class="comment">//循环遍历长度</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="variable">$rgb</span> = imagecolorat(<span class="variable">$res</span>,<span class="variable">$j</span>,<span class="variable">$i</span>);	<span class="comment">//取得某像素的颜色索引值</span></span><br><span class="line">					<span class="variable">$rgbarray</span> = imagecolorsforindex(<span class="variable">$res</span>, <span class="variable">$rgb</span>);	<span class="comment">// 取出red，green，blue 和 alpha 的键名的关联数组</span></span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$rgbarray</span>[<span class="string">'red'</span>] &lt; <span class="number">160</span> || <span class="variable">$rgbarray</span>[<span class="string">'green'</span>] &lt; <span class="number">160</span> || <span class="variable">$rgbarray</span>[<span class="string">'blue'</span>] &lt; <span class="number">160</span>)	<span class="comment">//比较RGB值</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$data</span>[<span class="variable">$i</span>][<span class="variable">$j</span>]=<span class="number">1</span>;	<span class="comment">//数字输出1</span></span><br><span class="line">					&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">						<span class="variable">$data</span>[<span class="variable">$i</span>][<span class="variable">$j</span>]=<span class="number">0</span>;	<span class="comment">//背景输出0</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$this</span>-&gt;DataArray = <span class="variable">$data</span>;	<span class="comment">//返回数据</span></span><br><span class="line">			<span class="variable">$this</span>-&gt;ImageSize = <span class="variable">$size</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span>	//获取每个像素点的坐标</span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="variable">$result</span> = <span class="string">""</span>;</span><br><span class="line">			<span class="variable">$data</span> = <span class="keyword">array</span>(<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">4</span>; ++<span class="variable">$i</span>)	<span class="comment">//循环,切割四个数字</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="variable">$x</span> = (<span class="variable">$i</span> * (WORD_WIDTH + WORD_SPACING)) + OFFSET_X;	<span class="comment">//计算每个数字的起始水平像素的值X</span></span><br><span class="line">				<span class="variable">$y</span> = OFFSET_Y;</span><br><span class="line">				<span class="keyword">for</span>(<span class="variable">$h</span> = <span class="variable">$y</span>; <span class="variable">$h</span> &lt; (OFFSET_Y + WORD_HIGHT); ++<span class="variable">$h</span>)	<span class="comment">//循环获取每个数字的竖直像素值</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">for</span>(<span class="variable">$w</span> = <span class="variable">$x</span>; <span class="variable">$w</span> &lt; (<span class="variable">$x</span> + WORD_WIDTH); ++<span class="variable">$w</span>)	<span class="comment">//循环获取水平像素值</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$data</span>[<span class="variable">$i</span>] .= <span class="variable">$this</span>-&gt;DataArray[<span class="variable">$h</span>][<span class="variable">$w</span>];	<span class="comment">//储存每个数字的二值码</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">			<span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$numKey</span> =&gt; <span class="variable">$numString</span>)	<span class="comment">//循环每个数字的二值码</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="variable">$max</span> = <span class="number">0.0</span>;</span><br><span class="line">				<span class="variable">$num</span> = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">foreach</span>(<span class="variable">$this</span>-&gt;Keys <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)	<span class="comment">//匹配每个的字模二值码</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="variable">$percent</span> = <span class="number">0.0</span>;	<span class="comment">//初始相似百分比</span></span><br><span class="line">					similar_text(<span class="variable">$value</span>, <span class="variable">$numString</span>, <span class="variable">$percent</span>);	<span class="comment">//计算两个字符串的相似度（以百分比计）</span></span><br><span class="line">					<span class="keyword">if</span>(intval(<span class="variable">$percent</span>) &gt; <span class="variable">$max</span>)	<span class="comment">//当前相似度与前一次循环的相似度比较，如果比前一次相似度高则</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$max</span> = <span class="variable">$percent</span>;	<span class="comment">//储存最大相似度百分比</span></span><br><span class="line">						<span class="variable">$num</span> = <span class="variable">$key</span>;	<span class="comment">//储存最大百分比的数字</span></span><br><span class="line">						<span class="keyword">if</span>(intval(<span class="variable">$percent</span>) &gt; <span class="number">95</span>)	<span class="comment">//将字符串与每一个字模的字符串比较，求其相似度，取最高的相似度对应的数字，或者相似度达到95%以上就可以断定是某个数字</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$result</span> .= <span class="variable">$num</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$this</span>-&gt;data = <span class="variable">$result</span>;</span><br><span class="line">	</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Draw</span><span class="params">()</span>	//按顺序取出每个相熟点的值（0/1）</span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$this</span>-&gt;ImageSize[<span class="number">1</span>]; ++<span class="variable">$i</span>)</span><br><span class="line">			&#123;</span><br><span class="line">		        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$this</span>-&gt;ImageSize[<span class="number">0</span>]; ++<span class="variable">$j</span>)</span><br><span class="line">			    &#123;</span><br><span class="line">				    <span class="keyword">echo</span> <span class="variable">$this</span>-&gt;DataArray[<span class="variable">$i</span>][<span class="variable">$j</span>];</span><br><span class="line">		        &#125;</span><br><span class="line">			    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span>	//二值化的每个数字</span><br><span class="line">		</span>&#123;</span><br><span class="line">			<span class="variable">$this</span>-&gt;Keys = <span class="keyword">array</span>(</span><br><span class="line">				<span class="string">'0'</span>=&gt;<span class="string">'00011000001111000110011011000011110000111100001111000011011001100011110000011000'</span>,</span><br><span class="line">				<span class="string">'1'</span>=&gt;<span class="string">'00011000001110000111100000011000000110000001100000011000000110000001100001111110'</span>,</span><br><span class="line">				<span class="string">'2'</span>=&gt;<span class="string">'00111100011001101100001100000011000001100000110000011000001100000110000011111111'</span>,</span><br><span class="line">				<span class="string">'3'</span>=&gt;<span class="string">'01111100110001100000001100000110000111000000011000000011000000111100011001111100'</span>,</span><br><span class="line">				<span class="string">'4'</span>=&gt;<span class="string">'00000110000011100001111000110110011001101100011011111111000001100000011000000110'</span>,</span><br><span class="line">				<span class="string">'5'</span>=&gt;<span class="string">'11111110110000001100000011011100111001100000001100000011110000110110011000111100'</span>,</span><br><span class="line">				<span class="string">'6'</span>=&gt;<span class="string">'00111100011001101100001011000000110111001110011011000011110000110110011000111100'</span>,</span><br><span class="line">				<span class="string">'7'</span>=&gt;<span class="string">'11111111000000110000001100000110000011000001100000110000011000001100000011000000'</span>,</span><br><span class="line">				<span class="string">'8'</span>=&gt;<span class="string">'00111100011001101100001101100110001111000110011011000011110000110110011000111100'</span>,</span><br><span class="line">				<span class="string">'9'</span>=&gt;<span class="string">'00111100011001101100001111000011011001110011101100000011010000110110011000111100'</span>,</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$ImagePath</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$DataArray</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$ImageSize</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$data</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$Keys</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$NumStringArray</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="preprocessor">?&gt;</span></span></span><br><span class="line"></span><br><span class="line">##NRC转UTF-8编码过程</span><br><span class="line"></span><br><span class="line">UTF-8的编码规则很简单，只有二条： </span><br><span class="line"></span><br><span class="line">1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。 </span><br><span class="line"></span><br><span class="line">2）对于n字节的符号（n&gt;1），第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的unicode码。 </span><br><span class="line"></span><br><span class="line">下表总结了编码规则，字母x表示可用编码的位。</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">table</span>&gt;</span><span class="tag">&lt;<span class="title">tr</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>Unicode符号范围(十六进制)<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>UTF-8编码方式（二进制）<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">tr</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>0000 0000-0000 007F<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>0xxxxxxx<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">tr</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>0000 0080-0000 07FF<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>110xxxxx 10xxxxxx<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">tr</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>0000 0800-0000 FFFF<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>1110xxxx 10xxxxxx 10xxxxxx<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">tr</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>0001 0000-0010 FFFF<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;<span class="title">td</span>&gt;</span>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx<span class="tag">&lt;/<span class="title">td</span>&gt;</span><span class="tag">&lt;/<span class="title">tr</span>&gt;</span><span class="tag">&lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">下面，还是以汉字“严”为例，演示如何实现UTF-8编码。 </span><br><span class="line"></span><br><span class="line">已知“严”的unicode是4E25（100111000100101），根据上表，可以发现4E25处在第三行的范围内（0000 0800-0000 FFFF），因此“严”的UTF-8编码需要三个字节，即格式是“1110xxxx 10xxxxxx 10xxxxxx”。然后，从“严”的最后一个二进制位开始，依次从后向前填入格式中的x，多出的位补0。这样就得到了，“严”的UTF-8编码是“11100100 10111000 10100101”，转换成十六进制就是E4B8A5。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	//*-----------------------------------u2utf82gb.php--------------------------------------*//</span><br><span class="line">	<span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">u2utf82gb</span><span class="params">(<span class="variable">$c</span>)</span></span>&#123;</span><br><span class="line">		<span class="variable">$str</span>=<span class="string">""</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$c</span> &lt; <span class="number">0x80</span>) &#123;</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="variable">$c</span>);	<span class="comment">//当NRC编码位于0000 0000-0000 007F区段时，UTF-8编码转换为0<span class="label">xxxxxxx</span></span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$c</span> &lt; <span class="number">0x800</span>) &#123;</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0xC0</span> | <span class="variable">$c</span>&gt;&gt;<span class="number">6</span>);	<span class="comment">//当NRC编码位于0000 0080-0000 07FF区段时，UTF-8编码转换为110<span class="label">xxxxx 10xxxxxx</span></span></span><br><span class="line">	 		<span class="variable">$str</span>.=chr(<span class="number">0x80</span> | <span class="variable">$c</span> &amp; <span class="number">0x3F</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$c</span> &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0xE0</span> | <span class="variable">$c</span>&gt;&gt;<span class="number">12</span>);	<span class="comment">//当NRC编码位于0000 0800-0000 FFFF区段时，UTF-8编码转换为1110<span class="label">xxxx 10xxxxxx 10xxxxxx</span></span></span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0x80</span> | <span class="variable">$c</span>&gt;&gt;<span class="number">6</span> &amp; <span class="number">0x3F</span>);</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0x80</span> | <span class="variable">$c</span> &amp; <span class="number">0x3F</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$c</span> &lt; <span class="number">0x200000</span>) &#123;</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0xF0</span> | <span class="variable">$c</span>&gt;&gt;<span class="number">18</span>);	<span class="comment">//当NRC编码位于0001 0000-0010 FFFF区段时，UTF-8编码转换为11110<span class="label">xxx 10xxxxxx 10xxxxxx 10xxxxxx</span></span></span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0x80</span> | <span class="variable">$c</span>&gt;&gt;<span class="number">12</span> &amp; <span class="number">0x3F</span>);</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0x80</span> | <span class="variable">$c</span>&gt;&gt;<span class="number">6</span> &amp; <span class="number">0x3F</span>);</span><br><span class="line">			<span class="variable">$str</span>.=chr(<span class="number">0x80</span> | <span class="variable">$c</span> &amp; <span class="number">0x3F</span>);</span><br><span class="line">		&#125;</span><br><span class="line">			<span class="keyword">return</span> iconv(<span class="string">'UTF-8'</span>, <span class="string">'GB2312'</span>, <span class="variable">$str</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="preprocessor">?&gt;</span></span></span><br><span class="line">##通过QR获取借阅信息</span><br><span class="line">`<span class="tag">&lt;<span class="title">2014</span>/<span class="attribute">7</span>/<span class="attribute">25</span>更新&gt;</span>`今天灵（nao）机（can）一动想到一个新想法，能否利用当前借阅最下边的二维码来获取图书的有关信息，于是用手机扫了一下二维码，发现真的可以获取图书的借阅信息。</span><br><span class="line">![扫描结果](http://picture-lotors.qiniudn.com/lotorsQRcode.jpg "扫描结果")</span><br><span class="line">于是查看了一下源码，找到了生成二维码的的地址。</span><br></pre></td></tr></table></figure></p>
<pre><code>&lt;img src=<span class="string">"../opac/ajax_qr.php?qrcode=6K<span class="variable">%2B76ICF44CQMzEyNTAwMjA3NuOAkeeahOWcqOWAn</span><span class="variable">%2BS5puWIiijpopjlkI0v5bqU6L</span><span class="variable">%2BY5pel5pyfKe</span><span class="variable">%2B8mg0KTHVh56iL5bqP6K6</span><span class="variable">%2B6K6hIDIwMTQtMDktMTQgICAgICAgIA0KUEhQ5a6e5L6L57K</span><span class="variable">%2B6YCaIDIwMTQtMDktMTQgICAgICAgIA0KQXJkdWlub</span><span class="variable">%2BS4gOivleWwseS4iuaJiy4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI</span><span class="variable">%2FnlLvlhaXpl6jovbvmnb7lraYs56u55a2QLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBbmRyb2lk54Ot6Zeo5bqU55So5byA5Y</span><span class="variable">%2BR6K</span><span class="variable">%2Bm6KejLi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI</span><span class="variable">%2FnlLvlhaXpl6jovbvmnb7lraYs6I2J5pys6Iqx5Y2JLi4gMjAxNC0wOS0xNCAgICAgICAgDQrlkI3lrrblm73nlLvor77loIIu6Iqx6bif56</span><span class="variable">%2BHLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBcmR1aW5v5oqA5pyv5YaF5bmVIDIwMTQtMDktMTQgICAgICAgIA0K55av54uCQW5kcm9pZOiusuS5iS4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQpqUXVlcnnlvIDlj5HmioDmnK</span><span class="variable">%2For6bop6MuLiAyMDE0LTA5LTE0ICAgICAgICANCg</span><span class="variable">%3D</span><span class="variable">%3D</span>"</span> border=<span class="string">"0"</span> /&gt;&lt;<span class="regexp">/a&gt;&lt;/span</span>&gt;
</code></pre><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这个二维码是由`<span class="javascript">http:<span class="comment">//210.34.85.114:8080/opac/ajax_qr.php</span></span>`这个服务器生成的，后面的qrcode应该是GB2312转UTF-<span class="number">8</span>后url编码产生，这里不去管它。</span><br><span class="line">由于直接利用PHP无法解析二维码，所以调用`<span class="javascript">http:<span class="comment">//zxing.org/w/decode.jspx</span></span>`这一个网页服务来对二维码解析。</span><br><span class="line">用Fidder分析数据发送，该页面是通过_GET方法`<span class="javascript">http:<span class="comment">//zxing.org/w/decode?u=</span></span>`后接查询图片的url来传递数据，这里的url是`<span class="javascript">http:<span class="comment">//210.34.85.114:8080/opac/ajax_qr.php</span></span>`这个服务器生成的二维码的地址。</span><br></pre></td></tr></table></figure>
<p>GET <a href="http://zxing.org/w/decode?u=http%3A%2F%2F210.34.85.114%3A8080%2Fopac%2Fajax_qr.php%3Fqrcode%3D6K%252B76ICF44CQMzEyNTAwMjA3NuOAkeeahOWcqOWAn%252BS5puWIiijpopjlkI0v5bqU6L%252BY5pel5pyfKe%252B8mg0KTHVh56iL5bqP6K6%252B6K6hIDIwMTQtMDktMTQgICAgICAgIA0KUEhQ5a6e5L6L57K%252B6YCaIDIwMTQtMDktMTQgICAgICAgIA0KQXJkdWlub%252BS4gOivleWwseS4iuaJiy4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%252FnlLvlhaXpl6jovbvmnb7lraYs56u55a2QLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBbmRyb2lk54Ot6Zeo5bqU55So5byA5Y%252BR6K%252Bm6KejLi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%252FnlLvlhaXpl6jovbvmnb7lraYs6I2J5pys6Iqx5Y2JLi4gMjAxNC0wOS0xNCAgICAgICAgDQrlkI3lrrblm73nlLvor77loIIu6Iqx6bif56%252BHLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBcmR1aW5v5oqA5pyv5YaF5bmVIDIwMTQtMDktMTQgICAgICAgIA0K55av54uCQW5kcm9pZOiusuS5iS4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQpqUXVlcnnlvIDlj5HmioDmnK%252For6bop6MuLiAyMDE0LTA5LTE0ICAgICAgICANCg%253D%253D" target="_blank" rel="external">http://zxing.org/w/decode?u=http%3A%2F%2F210.34.85.114%3A8080%2Fopac%2Fajax_qr.php%3Fqrcode%3D6K%252B76ICF44CQMzEyNTAwMjA3NuOAkeeahOWcqOWAn%252BS5puWIiijpopjlkI0v5bqU6L%252BY5pel5pyfKe%252B8mg0KTHVh56iL5bqP6K6%252B6K6hIDIwMTQtMDktMTQgICAgICAgIA0KUEhQ5a6e5L6L57K%252B6YCaIDIwMTQtMDktMTQgICAgICAgIA0KQXJkdWlub%252BS4gOivleWwseS4iuaJiy4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%252FnlLvlhaXpl6jovbvmnb7lraYs56u55a2QLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBbmRyb2lk54Ot6Zeo5bqU55So5byA5Y%252BR6K%252Bm6KejLi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%252FnlLvlhaXpl6jovbvmnb7lraYs6I2J5pys6Iqx5Y2JLi4gMjAxNC0wOS0xNCAgICAgICAgDQrlkI3lrrblm73nlLvor77loIIu6Iqx6bif56%252BHLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBcmR1aW5v5oqA5pyv5YaF5bmVIDIwMTQtMDktMTQgICAgICAgIA0K55av54uCQW5kcm9pZOiusuS5iS4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQpqUXVlcnnlvIDlj5HmioDmnK%252For6bop6MuLiAyMDE0LTA5LTE0ICAgICAgICANCg%253D%253D</a> HTTP/1.1<br>Host: zxing.org<br>Connection: keep-alive<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8<br>User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1883.0 Safari/537.36<br>Referer: <a href="http://zxing.org/w/decode.jspx" target="_blank" rel="external">http://zxing.org/w/decode.jspx</a><br>Accept-Encoding: gzip,deflate,sdch<br>Accept-Language: en-US,en;q=0.8,zh-CN;q=0.6,zh;q=0.4<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>//<em>—————————————————-qrcode.php———————————————————</em>//<br>&lt;?php<br>    function qrcode($src){<br>        //切割html字符串获取图片url<br>        preg_match_all(‘/&lt;img\ssrc=\”[^\”]+\”/‘,$src,$qr);<br>        //截取的””中间的url<br>        preg_match_all(‘/\”[^\”]+/‘,$qr[0][0],$qrcode);<br>        //除去开头的 ..<br>        $qrcode = preg_replace(‘/../‘,’’,$qrcode[0][0]);<br>        //除去开头的 “<br>        $qrcode = preg_replace(‘/\”/‘,’’,$qrcode);<br>        //拼接url<br>        $qrcode = ‘<a href="http://210.34.85.114:8080&#39;.$qrcode" target="_blank" rel="external">http://210.34.85.114:8080&#39;.$qrcode</a>;<br>        //url编码<br>        $qrcode = urlencode($qrcode);<br>        //拼接查询url<br>        $url = ‘<a href="http://zxing.org/w/decode?u=&#39;.$qrcode" target="_blank" rel="external">http://zxing.org/w/decode?u=&#39;.$qrcode</a>;<br>        //获取数据<br>        $curl = curl_init($url);<br>        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);<br>        $infomation = curl_exec($curl);<br>        curl_close($curl);</p>
<pre><code>    <span class="comment">//获取QRcode信息</span>
    preg_match_all(<span class="string">'/读者[^&lt;]+/'</span>,<span class="variable">$infomation</span>,<span class="variable">$info</span>);
    <span class="comment">//UTF-8转GB2312</span>
    <span class="variable">$info</span> = iconv(<span class="string">'UTF-8'</span>,<span class="string">'GB2312'</span>,<span class="variable">$info</span>[<span class="number">0</span>][<span class="number">0</span>]);
    print_r(<span class="variable">$info</span>);
}
</code></pre><p>?&gt;<br>```</p>
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP/"> #PHP </a>
          
            <a href="/tags/QRcode/"> #QRcode </a>
          
            <a href="/tags/图书馆/"> #图书馆 </a>
          
            <a href="/tags/开发/"> #开发 </a>
          
            <a href="/tags/微信公众平台/"> #微信公众平台 </a>
          
            <a href="/tags/模拟登入/"> #模拟登入 </a>
          
            <a href="/tags/笔记/"> #笔记 </a>
          
            <a href="/tags/编码/"> #编码 </a>
          
            <a href="/tags/验证码/"> #验证码 </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2014/07/26/@font-face/">在网页中插入特殊字体,浅谈@font-face</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2014/07/23/DHT11ATLEWEI/">微信公众平台实时监控室内温度和湿度</a>
            
          </div>
        </div>
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="2014/07/25/Weixin-Library-BookSearch/" data-title="微信公众平台图书馆查询开发记录" data-url="http://masukio.tk/2014/07/25/Weixin-Library-BookSearch/">
          </div>
        
      </div>
    
  </div>


        </div>
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="masukio">
          <p class="site-author-name">masukio</p>
        </div>
        <p class="site-description motion-element">醉后不知天在水,围着火炉吃西瓜</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">75</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml">
              <i class="menu-item-icon icon-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/fjkfwz" target="_blank">github</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/andymckees" target="_blank">weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="/atom.xml" target="_blank">rss</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.zhihu.com/people/rice-lyn" target="_blank">zhihu</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="fjkfwz@gmail.com" target="_blank">mail</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://www.facebook.com/mckee.andy1" target="_blank">facebook</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://plus.google.com/u/1/115513142719872189331/posts" target="_blank">google</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/AndyMckees" target="_blank">twitter</a>
            </span>
            
          
        </div>

        
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Fidder2解析图书馆登入系统过程"><span class="nav-number">1.</span> <span class="nav-text">Fidder2解析图书馆登入系统过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Fidder2介绍"><span class="nav-number">1.1.</span> <span class="nav-text">Fidder2介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过Fidder查看图书馆登入过程"><span class="nav-number">1.2.</span> <span class="nav-text">通过Fidder查看图书馆登入过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模拟图书馆登入系统过程"><span class="nav-number">2.</span> <span class="nav-text">模拟图书馆登入系统过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#机器识别验证码"><span class="nav-number">2.1.</span> <span class="nav-text">机器识别验证码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————"><span class="nav-number">2.2.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-1"><span class="nav-number">2.3.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-2"><span class="nav-number">2.4.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-3"><span class="nav-number">2.5.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-4"><span class="nav-number">2.6.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-5"><span class="nav-number">2.7.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-6"><span class="nav-number">2.8.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-7"><span class="nav-number">2.9.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#————0000————0000————0000————-00——————-"><span class="nav-number">2.10.</span> <span class="nav-text">————0000————0000————0000————-00——————-</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-8"><span class="nav-number">2.11.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-9"><span class="nav-number">2.12.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-10"><span class="nav-number">2.13.</span> <span class="nav-text">——————————————————————————————</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#——————————————————————————————-11"><span class="nav-number">2.14.</span> <span class="nav-text">——————————————————————————————</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2014 - 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">masukio</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.content img').each(function () {
        var $image = $(this);
        var $imageWrapLink = $image.parent('a');

        if ($imageWrapLink.size() < 1) {
          $imageWrapLink = $image.wrap('<a href="' + this.getAttribute('src') + '"></a>').parent('a');
        }
        $imageWrapLink.addClass('fancybox');
      });
    });
    $('.fancybox').fancybox({
      helpers: {
        overlay: {
          locked: false
        }
      }
    });
  </script>


  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

  //Show Sidebar
  sidebarShowMotion();
  isSidebarVisible = !isSidebarVisible;

  function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.logo-line-before i'), p: { translateX: "100%" }, o: { duration: 500, sequenceQueue: false } },
        { e: $('.logo-line-after i'), p: { translateX: "-100%" }, o: { duration: 500, sequenceQueue: false } },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  
  
<script type="text/javascript" id="bootstrap.scrollspy.custom">
  /* ========================================================================
  * Bootstrap: scrollspy.js v3.3.2
  * http://getbootstrap.com/javascript/#scrollspy
  * ========================================================================
  * Copyright 2011-2015 Twitter, Inc.
  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
  * ======================================================================== */

  /**
   * Custom by iissnan
   *
   * - Add a `clear.bs.scrollspy` event.
   * - Esacpe targets selector.
   */


  +function ($) {
    'use strict';

    // SCROLLSPY CLASS DEFINITION
    // ==========================

    function ScrollSpy(element, options) {
      this.$body          = $(document.body)
      this.$scrollElement = $(element).is(document.body) ? $(window) : $(element)
      this.options        = $.extend({}, ScrollSpy.DEFAULTS, options)
      this.selector       = (this.options.target || '') + ' .nav li > a'
      this.offsets        = []
      this.targets        = []
      this.activeTarget   = null
      this.scrollHeight   = 0

      this.$scrollElement.on('scroll.bs.scrollspy', $.proxy(this.process, this))
      this.refresh()
      this.process()
    }

    ScrollSpy.VERSION  = '3.3.2'

    ScrollSpy.DEFAULTS = {
      offset: 10
    }

    ScrollSpy.prototype.getScrollHeight = function () {
      return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight)
    }

    ScrollSpy.prototype.refresh = function () {
      var that          = this
      var offsetMethod  = 'offset'
      var offsetBase    = 0

      this.offsets      = []
      this.targets      = []
      this.scrollHeight = this.getScrollHeight()

      if (!$.isWindow(this.$scrollElement[0])) {
        offsetMethod = 'position'
        offsetBase   = this.$scrollElement.scrollTop()
      }

      this.$body
        .find(this.selector)
        .map(function () {
          var $el   = $(this)
          var href  = $el.data('target') || $el.attr('href')
          var $href = /^#./.test(href) && $(escapeSelector(href)) // Need to escape selector.

          return ($href
            && $href.length
            && $href.is(':visible')
            && [[$href[offsetMethod]().top + offsetBase, href]]) || null
        })
        .sort(function (a, b) { return a[0] - b[0] })
        .each(function () {
          that.offsets.push(this[0])
          that.targets.push(this[1])
        })


    }

    ScrollSpy.prototype.process = function () {
      var scrollTop    = this.$scrollElement.scrollTop() + this.options.offset
      var scrollHeight = this.getScrollHeight()
      var maxScroll    = this.options.offset + scrollHeight - this.$scrollElement.height()
      var offsets      = this.offsets
      var targets      = this.targets
      var activeTarget = this.activeTarget
      var i

      if (this.scrollHeight != scrollHeight) {
        this.refresh()
      }

      if (scrollTop >= maxScroll) {
        return activeTarget != (i = targets[targets.length - 1]) && this.activate(i)
      }

      if (activeTarget && scrollTop < offsets[0]) {
        $(this.selector).trigger('clear.bs.scrollspy')  // Add a custom event.
        this.activeTarget = null
        return this.clear()
      }

      for (i = offsets.length; i--;) {
        activeTarget != targets[i]
          && scrollTop >= offsets[i]
          && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
          && this.activate(targets[i])
      }
    }

    ScrollSpy.prototype.activate = function (target) {
      this.activeTarget = target

      this.clear()

      var selector = this.selector +
        '[data-target="' + target + '"],' +
        this.selector + '[href="' + target + '"]'

      var active = $(selector)
        .parents('li')
        .addClass('active')

      if (active.parent('.dropdown-menu').length) {
        active = active
          .closest('li.dropdown')
          .addClass('active')
      }

      active.trigger('activate.bs.scrollspy')
    }

    ScrollSpy.prototype.clear = function () {
      $(this.selector)
        .parentsUntil(this.options.target, '.active')
        .removeClass('active')
    }


    // SCROLLSPY PLUGIN DEFINITION
    // ===========================

    function Plugin(option) {
      return this.each(function () {
        var $this   = $(this)
        var data    = $this.data('bs.scrollspy')
        var options = typeof option == 'object' && option

        if (!data) $this.data('bs.scrollspy', (data = new ScrollSpy(this, options)))
        if (typeof option == 'string') data[option]()
      })
    }

    var old = $.fn.scrollspy

    $.fn.scrollspy             = Plugin
    $.fn.scrollspy.Constructor = ScrollSpy


    // SCROLLSPY NO CONFLICT
    // =====================

    $.fn.scrollspy.noConflict = function () {
      $.fn.scrollspy = old
      return this
    }


    // SCROLLSPY DATA-API
    // ==================

    $(window).on('load.bs.scrollspy.data-api', function () {
      $('[data-spy="scroll"]').each(function () {
        var $spy = $(this)
        Plugin.call($spy, $spy.data())
      })
    })

  }(jQuery);
</script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      
    });
  </script>




  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lotors"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
</body>
</html>