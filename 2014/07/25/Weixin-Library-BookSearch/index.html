<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta name="description" content="记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2 解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode 转 UTF-8编码过程（5）微信公众账号的绑定（6）Memcache 缓存技术(7)正则表达式">
<meta name="keywords" content="微信公众平台,开发,PHP,笔记,编码,QRcode,验证码,模拟登入,图书馆">
<meta property="og:type" content="article">
<meta property="og:title" content="微信公众平台图书馆查询开发记录">
<meta property="og:url" content="https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/index.html">
<meta property="og:site_name" content="Sapientia et Virtus">
<meta property="og:description" content="记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2 解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode 转 UTF-8编码过程（5）微信公众账号的绑定（6）Memcache 缓存技术(7)正则表达式">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%812.JPG">
<meta property="og:image" content="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%813.JPG">
<meta property="og:image" content="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%814.JPG">
<meta property="og:image" content="http://picture-lotors.qiniudn.com/lotorsQRcode.jpg">
<meta property="og:updated_time" content="2017-12-25T14:28:22.382Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微信公众平台图书馆查询开发记录">
<meta name="twitter:description" content="记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2 解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode 转 UTF-8编码过程（5）微信公众账号的绑定（6）Memcache 缓存技术(7)正则表达式">
<meta name="twitter:image" content="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%812.JPG">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>微信公众平台图书馆查询开发记录</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Sapientia et Virtus" type="application/atom+xml">
    
</head>
<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast')" style="display:none"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/fjkfwz">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2014/07/26/@font-face/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i></a></li>
        
        
        <li><a class="icon" href="/2014/07/23/DHT11ATLEWEI/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast')"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="$('#share').toggle();return false"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none">Previous post</span>
      <span id="i-next" class="info" style="display:none">Next post</span>
      <span id="i-top" class="info" style="display:none">Back to top</span>
      <span id="i-share" class="info" style="display:none">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&text=微信公众平台图书馆查询开发记录"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&is_video=false&description=微信公众平台图书馆查询开发记录"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=微信公众平台图书馆查询开发记录&body=Check out this article: https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/"><i class="fa fa-envelope" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-reddit" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-digg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&name=微信公众平台图书馆查询开发记录&description=&lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;：这篇文章记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode 转 UTF-8 编码过程（5）微信公众账号的绑定（6）Memcache 缓存技术(7)正则表达式&lt;br&gt;"><i class="fa fa-tumblr" aria-hidden="true"></i></a></li>
</ul>
    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Fidder2解析图书馆登入系统过程"><span class="toc-number">1.</span> <span class="toc-text"><a href="#Fidder2&#x89E3;&#x6790;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;" class="headerlink" title="Fidder2&#x89E3;&#x6790;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;"></a>Fidder2&#x89E3;&#x6790;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Fidder2介绍"><span class="toc-number">1.1.</span> <span class="toc-text"><a href="#Fidder2&#x4ECB;&#x7ECD;" class="headerlink" title="Fidder2&#x4ECB;&#x7ECD;"></a>Fidder2&#x4ECB;&#x7ECD;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过-Fidder-查看图书馆登入过程"><span class="toc-number">1.2.</span> <span class="toc-text"><a href="#&#x901A;&#x8FC7;-Fidder-&#x67E5;&#x770B;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x901A;&#x8FC7; Fidder &#x67E5;&#x770B;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x8FC7;&#x7A0B;"></a>&#x901A;&#x8FC7; Fidder &#x67E5;&#x770B;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x8FC7;&#x7A0B;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模拟图书馆登入系统过程"><span class="toc-number">2.</span> <span class="toc-text"><a href="#&#x6A21;&#x62DF;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x6A21;&#x62DF;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;"></a>&#x6A21;&#x62DF;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#机器识别验证码"><span class="toc-number">2.1.</span> <span class="toc-text"><a href="#&#x673A;&#x5668;&#x8BC6;&#x522B;&#x9A8C;&#x8BC1;&#x7801;" class="headerlink" title="&#x673A;&#x5668;&#x8BC6;&#x522B;&#x9A8C;&#x8BC1;&#x7801;"></a>&#x673A;&#x5668;&#x8BC6;&#x522B;&#x9A8C;&#x8BC1;&#x7801;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NRC-转-UTF-8编码过程"><span class="toc-number">2.2.</span> <span class="toc-text"><a href="#NRC-&#x8F6C;-UTF-8&#x7F16;&#x7801;&#x8FC7;&#x7A0B;" class="headerlink" title="NRC &#x8F6C; UTF-8&#x7F16;&#x7801;&#x8FC7;&#x7A0B;"></a>NRC &#x8F6C; UTF-8&#x7F16;&#x7801;&#x8FC7;&#x7A0B;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过-QR-获取借阅信息"><span class="toc-number">2.3.</span> <span class="toc-text"><a href="#&#x901A;&#x8FC7;-QR-&#x83B7;&#x53D6;&#x501F;&#x9605;&#x4FE1;&#x606F;" class="headerlink" title="&#x901A;&#x8FC7; QR &#x83B7;&#x53D6;&#x501F;&#x9605;&#x4FE1;&#x606F;"></a>&#x901A;&#x8FC7; QR &#x83B7;&#x53D6;&#x501F;&#x9605;&#x4FE1;&#x606F;</span></a></li></ol></li></ol>
    </div>
  </span>
</div>
    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 class="posttitle" itemprop="name headline">
        微信公众平台图书馆查询开发记录
    </h1>
    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Sapientia et Virtus</span>
      </span>
      <div class="postdate">
        <time datetime="2014-07-25T00:00:00.000Z" itemprop="datePublished">Jul 25 2014</time>
    </div>
      <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/PHP/">PHP</a>, <a class="tag-link" href="/tags/QRcode/">QRcode</a>, <a class="tag-link" href="/tags/图书馆/">图书馆</a>, <a class="tag-link" href="/tags/开发/">开发</a>, <a class="tag-link" href="/tags/微信公众平台/">微信公众平台</a>, <a class="tag-link" href="/tags/模拟登入/">模拟登入</a>, <a class="tag-link" href="/tags/笔记/">笔记</a>, <a class="tag-link" href="/tags/编码/">编码</a>, <a class="tag-link" href="/tags/验证码/">验证码</a>
    </div>
    </div>
  </header>
  
  <div class="content" itemprop="articleBody">
    <p><strong>摘要</strong>：这篇文章记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode 转 UTF-8 编码过程（5）微信公众账号的绑定（6）Memcache 缓存技术(7)正则表达式<br><a id="more"></a><br>这是一篇记录我的第一个微信应用——福建农林大学图书馆服务的开发记录，应用架设在 Sina App Engine,开发目标是解决手机登入 web 查看图书不便的问题，并提供响应的服务功能，比如（1）图书5天内图书到期的提醒（2）图书的查询服务（3）图书借阅的查询服务（4）暂时图书馆没有藏书的到书提醒（5）免验证码登陆，算是对自己多天折腾的总结并提供有相关需求的朋友一些思路。</p>
<h1 id="Fidder2解析图书馆登入系统过程"><a href="#Fidder2解析图书馆登入系统过程" class="headerlink" title="Fidder2解析图书馆登入系统过程"></a>Fidder2解析图书馆登入系统过程</h1><h2 id="Fidder2介绍"><a href="#Fidder2介绍" class="headerlink" title="Fidder2介绍"></a>Fidder2介绍</h2><blockquote>
<p>Fiddler 是一个 http 协议调试代理工具，它能够记录并检查所有你的电脑和互联网之间的 http 通讯，设置断点，查看所有的“进出”Fiddler 的数据（指 cookie,html,js,css 等文件，这些都可以让你胡乱修改的意思）。 Fiddler 要比其他的网络调试器要更加简单，因为它不仅仅暴露 http 通讯还提供了一个用户友好的格式。</p>
</blockquote>
<p>利用 Fidder 可以方便的从数据连接中扒取链接的信息，即使是表单是通过_POST，我们也能够很方便的从数据流中截取用户发送的信息，从而将机器伪装成人肉对服务器进行请求，实现模拟登入。</p>
<h2 id="通过-Fidder-查看图书馆登入过程"><a href="#通过-Fidder-查看图书馆登入过程" class="headerlink" title="通过 Fidder 查看图书馆登入过程"></a>通过 Fidder 查看图书馆登入过程</h2><p>首先，打开 Fidder，开始对通信进行监听，登入我们的目标站点——福建农林大学图书馆的登入页面<code>http://210.34.85.114:8080/reader/login.php</code>,输入学号，密码和验证码（正不正确不重要，这里主要查看数据的发送格式），选择<code>证件号</code>，点击<code>登入</code>，打开 Fidder，选择验证服务器的 url<code>http://210.34.85.114:8080/reader/redr_verify.php</code>，在<code>Inspectors 下的 Raw 标签</code>下可以看到发送的信息，如下</p>
<pre><code>POST http://210.34.85.114:8080/reader/redr_verify.php HTTP/1.1
Host: 210.34.85.114:8080
User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://210.34.85.114:8080/reader/login.php
Cookie: PHPSESSID=ordh88pv46g9jco23d32pvqer3
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 70

number=3125002076&amp;passwd=147qj9&amp;captcha=1173&amp;select=cert_no&amp;returnUrl=
</code></pre><p>发送的目标地址</p>
<pre><code>POST http://210.34.85.114:8080/reader/redr_verify.php HTTP/1.1
</code></pre><p>用户进行浏览器的头文件为：</p>
<pre><code>User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
</code></pre><p>用户发送的信息格式为：</p>
<pre><code>number=3125002076&amp;passwd=147qj9&amp;captcha=1173&amp;select=cert_no&amp;returnUrl=
</code></pre><p>后头我们将对这些信息进行封装，通过 curl POST 至目标地址<code>http://210.34.85.114:8080/reader/redr_verify.php HTTP/1.1</code>。<br>由于本文涉及到验证码的机器识别，所以我们还需要获取生成验证码的服务器地址，Fidder 中我们可以找到生成验证码的 url<code>http://210.34.85.114:8080/reader/captcha.php</code>，返回数据格式为<code>captcha.gif</code></p>
<h1 id="模拟图书馆登入系统过程"><a href="#模拟图书馆登入系统过程" class="headerlink" title="模拟图书馆登入系统过程"></a>模拟图书馆登入系统过程</h1><pre><code>//*-----------------------------------WXLibSearch.php--------------------------------------*//
&lt;?php
include (&apos;Valite.php&apos;);    //验证码识别类
include (&apos;u2utf82gb.php&apos;);    //NCR 转 GB2312类
//获取用户键入的信息
function getborrowedbookinfo ($keyword){

    /*
    *正则表达式检测用户输入信息是否为&quot;学号（10位）+密码&quot;
    *如果是则进行模拟登入获取借阅信息
    *如果输入错误则返回&quot;请按照格式输入学号和密码&quot;
    */

    if (preg_match_all(&quot;/^(\d{10})\+\S+/&quot;,$keyword,$info&quot;)){

        //切割字符串，学号为前10位（0-9），密码为第11后（10-）
        $num=substr($info,0,9);    //学号
        $pass=substr($info,11);    //密码


        //获取验证码 url
        $url = &quot;http://210.34.85.114:8080/reader/captcha.php&quot;;
        //保存 cookie 在当前路径下的&quot;valid.tmp&quot;文件之中，跨页面传递用户信息
        $cookie = dirname(__FILE__).&quot;/valid.tmp&quot;;

        //curl 访问验证码图片网址，把返回的 cookie 保存为 valid.tmp 文件
        $curl = curl_init($url);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);    //设定返回 的数据是否自动显示
        curl_setopt($curl, CURLOPT_COOKIEFILE, $cookie);
        curl_setopt($curl, CURLOPT_COOKIEJAR, $cookie);    // 把返回来的 cookie 信息保存在$cookie 文件中
        $data = curl_exec($curl);
        curl_close($curl);

        //保存验证码图片
        $fp = fopen(&quot;valid.gif&quot;,&quot;wb&quot;);
        fwrite($fp, $data);
        fclose($fp); 

        //识别验证码图片
        $valid = new Valite();
        $valid-&gt;setImage(&quot;valid.gif&quot;);
        $valid-&gt;getHec();
        $validCode = $valid-&gt;run();


        //组装数据
        $data = &quot;number=&quot;.$num.&quot;&amp;passwd=&quot;.$pass.&quot;&amp;captcha=&quot;.$validCode.&quot;&amp;select=cert_no&amp;returnUrl=&quot;;
        //头文件
        $headers = array(
            &quot;User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0&quot;,&quot;Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;,
            &quot;Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3&quot;,
            &quot;Accept-Encoding: gzip, deflate&quot;,
            );

        //curl 发送数据进行登陆
        $url = &quot;http://210.34.85.114:8080/reader/redr_verify.php&quot;;
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);    /设定是否显示头信息
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_COOKIEFILE, $cookie);
        curl_setopt($curl, CURLOPT_POST, 1);
        curl_setopt($curl,CURLOPT_POSTFIELDS,$data);
        $src = curl_exec($curl);
        curl_close($curl);

        //利用 cookie 进行借阅图书查询
        $url = &quot;http://210.34.85.114:8080/reader/book_lst.php&quot;;
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_COOKIEFILE, $cookie);
        $src = curl_exec($curl);
        curl_close($curl);

        //截取出 html 中的书名

        $booknum = preg_match_all(&apos;/&lt;a[^&gt;]+&gt;\S+&lt;\/a&gt;/&apos;,$src,$bookinfo);
        $hadborrowed = $booknum-23;    //当前借阅量
        $bookborrowed = &quot;当前借阅量：$hadborrowed&quot;;
        $bookborrowed = iconv(&apos;UTF-8&apos;, &apos;GB2312&apos;, $bookborrowed);
        $books = &quot;&quot;;    //建立容器储存书名
        $n = 0;    //用于为标题名前加上标号
        for ($i=23;$i&lt;$booknum;$i++){
        $n = $n+1;    
        $str1 = &quot;&quot;;    //建立容器用于储存转化为 GB2312的字符，每循环一次数据清空，储存到$books 容器之中
            //unicode 转化为 utf-8
            //通过 explode，标记为&quot;;&quot;将字符串切割成单个 Uincode 编码字符
            $bookinf = explode(&apos;;&apos;,$bookinfo[0][$i]);
            foreach($bookinf as $bookinfx){    //遍历字符串字符进行转码
                $bookinfx = preg_replace(&apos;/&lt;[^&gt;]+&gt;/&apos;,&apos;&apos;,$bookinfx);    //除去头尾字符的 html 标签
                $code = substr($bookinfx,3);    //除去16位 NCR 编码的表示部分&quot;&amp;# x&quot;
                $unicode = hexdec($code);    //16进制转化我10进制
                $string = u2utf82gb($unicode);    //Unicode 转 GB2312
                $str1 = $str1.$string;    //将转码后的单个字符拼接起来
            }
            $books = $books.$n.&quot;.&quot;.$str1;    //将每个书名拼接起来并加上标号&quot;$n.&quot;
        }

        echo $bookborrowed.&quot;\n&quot;.$books;    //输出借阅的图书量加上书名输出测试
    }
}

?&gt;
</code></pre><h2 id="机器识别验证码"><a href="#机器识别验证码" class="headerlink" title="机器识别验证码"></a>机器识别验证码</h2><p>验证码识别一般分为以下几个步骤：<br>一、取出字模<br>识别验证码，毕竟不是专业的 OCR 识别，并且，由于各个网站的验证码各不相同，所以，最常见的方法就是就是建立这个验证码的特征码库。去字模时，我们需要多下载几张图片，使这些图片中，包括所有的字符，我们这里的图片里只有数字，所以，只要收集到包括0-9的数字图片即可。</p>
<p>1、多刷新几次验证码，将验证码图片保存起来，要搜集齐0-9的图片，这里我收集了4张验证码才凑齐0~9 10位数字。</p>
<p><img src="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%812.JPG" alt="验证码" title="验证码"></p>
<p>2、用图片处理软件打开图片，我用的是 Photoshop，按住 ctrl+可以将图片的视图放大，这样就能很清楚地观察到图片的每个像素。</p>
<p><img src="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%813.JPG" alt="放大后的验证码" title="放大后的验证码"></p>
<p>可以发现，每个数字的宽是8px，高是10px，数字的间隔是4px，第一个数字左边偏移了6px，顶部偏移了16px。这些数字后面都是要用到的。<br>3、将每个数字截出来保存为图片，大小为8*10（虽然数字1的宽只占了7个像素，但是还是要截取8个像素的宽度）。</p>
<p>二、图片二值化<br>二值化就是把图片上的验证数字上每个象素用数字1表示，其它部分用0表示。把要识别的图片，进行二值化，将数据保存到二维数组里，得到图片特征数组。</p>
<p>1、首先要将数字和背景色和干扰色区分开来，用屏幕取色器观察颜色的规律。<br>可以得出一个结论：背景颜色的 R、G、B 值都是大于200的，而数字的颜色的 R、G、B 值的某一项有小于200，因此可以很容易区分。</p>
<p>2、下面的 php 代码只是为了演示二维数组，为了直观看出数字，所以把1和0改为了0和-：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;&lt;br&gt;&lt;img src=&quot;captcha.gif&quot;&gt;&lt;br&gt;&lt;br&gt;&apos;;</span><br><span class="line"> </span><br><span class="line">getHec(&quot;captcha.gif&quot;);	//&quot;captcha.gif&quot;中的值为8690</span><br><span class="line"> </span><br><span class="line">function getHec($imagePath) &#123;</span><br><span class="line">    $res = imagecreatefromjpeg($imagePath);</span><br><span class="line">    $size = getimagesize($imagePath);</span><br><span class="line">    </span><br><span class="line">    for ($i = 0; $i &lt; $size[1]; ++$i) &#123;</span><br><span class="line">        for ($j = 0; $j &lt; $size[0]; ++$j) &#123;</span><br><span class="line">            $rgb = imagecolorat($res, $j, $i);</span><br><span class="line">            $rgbarray = imagecolorsforindex($res, $rgb);</span><br><span class="line">            if ($rgbarray[&apos;red&apos;] &lt; 200 || $rgbarray[&apos;green&apos;]&lt;200 || $rgbarray[&apos;blue&apos;] &lt; 200) &#123;</span><br><span class="line">                echo &quot;0&quot;;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                echo &quot;-&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>二值化的结果如下图所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">--------0000--------0000--------0000---------00-------------</span><br><span class="line">-------00--00------00--00------00--00-------0000------------</span><br><span class="line">------00----00----00----0-----00----00-----00--00-----------</span><br><span class="line">-------00--00-----00----------00----00----00----00----------</span><br><span class="line">--------0000------00-000-------00--000----00----00----------</span><br><span class="line">-------00--00-----000--00-------000-00----00----00----------</span><br><span class="line">------00----00----00----00----------00----00----00----------</span><br><span class="line">------00----00----00----00-----0----00-----00--00-----------</span><br><span class="line">-------00--00------00--00------00--00-------0000------------</span><br><span class="line">--------0000--------0000--------0000---------00-------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>如果图片的背景颜色比较复杂，处理方法也是一样的，总能找到临界值来区分，具体要靠自己观察了。</p>
<p>三、数字字模二值化<br>计算出每个数字字模的二值化的数据，记录下这些数据，当作 key 即可。</p>
<p>1、将0-9的数字字模图片进行二值化，逐个取出图片的像个像素的颜色，然后获取每个像素的 R、G、B 值，再进行判断，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">for ($i = 0; $i &lt; 10; $i++) &#123;</span><br><span class="line">    echo &quot;&apos;$i&apos;=&gt;&apos;&quot;;</span><br><span class="line">    echo getHec(&quot;$i.jpg&quot;).&quot;&apos;,&lt;br&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function getHec($imagePath) &#123;</span><br><span class="line">    $res = imagecreatefromjpeg($imagePath);</span><br><span class="line">    $size = getimagesize($imagePath);</span><br><span class="line">    </span><br><span class="line">    for ($i = 0; $i &lt; $size[1]; ++$i) &#123;</span><br><span class="line">        for ($j = 0; $j &lt; $size[0]; ++$j) &#123;</span><br><span class="line">            $rgb = imagecolorat($res, $j, $i);</span><br><span class="line">            $rgbarray = imagecolorsforindex($res, $rgb);</span><br><span class="line">            if ($rgbarray[&apos;red&apos;] &lt; 200 || $rgbarray[&apos;green&apos;]&lt;200 || $rgbarray[&apos;blue&apos;] &lt; 200) &#123;</span><br><span class="line">                echo &quot;1&quot;;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                echo &quot;0&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">&apos;0&apos; =&gt; &apos;011110100001100001100001100001100001100001100001100001011110&apos;,</span><br><span class="line">&apos;1&apos; =&gt; &apos;001000111000001000001000001000001000001000001000001000111110&apos;,</span><br><span class="line">&apos;2&apos; =&gt; &apos;011110100001100001000001000010000100001000010000110011111111&apos;,</span><br><span class="line">&apos;3&apos; =&gt; &apos;011110100001100001000010001100000010000001100001100001011110&apos;,</span><br><span class="line">&apos;4&apos; =&gt; &apos;000100000100001100010100100100100100111111000100001100001111&apos;,</span><br><span class="line">&apos;5&apos; =&gt; &apos;111111100000100000101110110001000001000001100001100001011110&apos;,</span><br><span class="line">&apos;6&apos; =&gt; &apos;001110010001100000100000101110110001100001100001100001011110&apos;,</span><br><span class="line">&apos;7&apos; =&gt; &apos;111111100010100010000100000100001000001000001000001000001000&apos;,</span><br><span class="line">&apos;8&apos; =&gt; &apos;011110100001100001100001011110010010100001100001100001011110&apos;,</span><br><span class="line">&apos;9&apos; =&gt; &apos;011100100010100001100001100011011101000001000001100010011100&apos;,</span><br></pre></td></tr></table></figure></p>
<p>四、对照样本<br>把步骤二中的图片特征码和步骤三中的验证码的字模进行对比，得到验证图片上的数字。<br>算法过程：</p>
<p>1、将图片二值化后的值保存到二维数组里。</p>
<p>2、通过循环，求出每一个数字的位置，要用到前面得到的数字的宽、高、间隔、左边偏移、顶部偏移。<br>例如：第 i 个数字左边偏移 =（数字宽 + 间隔）* i + 左边偏移。</p>
<p>3、知道了数字的偏移位置，就可以计算出数字在二维数组里的位置，通过循环将数字的6*10=60个数据取出来拼接在一起，就形成了与数字字模类似的字符串。</p>
<p>4、将字符串与每一个字模的字符串比较，求其相似度，取最高的相似度对应的数字，或者相似度达到95%以上就可以断定是某个数字。</p>
<p>5、识别结果如下：</p>
<p><img src="http://picture-lotors.qiniudn.com/lotors%E9%AA%8C%E8%AF%81%E7%A0%814.JPG" alt="识别结果" title="识别结果"></p>
<p>使用目前这种方法，对验证码的识别基本上可以做到100%。<br>通过以上步骤，您可能说了，并没有发现如何取出干扰素啊！其实取出干扰素的方法很简单，干扰素的一个重要特征是，不能影响验证码的显示效果，所以制作干扰素时它的 RGB 可能低于或者高于某个特定值，比如我给的例子中的图片，干扰素的 RGB 各项值是不会小于200的，所以，这样我们就很容易去掉干扰素了。</p>
<pre><code>//*-----------------------------------Valite.php--------------------------------------*//
&lt;?php

define(&apos;WORD_WIDTH&apos;,8);    //定义每个字符的高度
define(&apos;WORD_HIGHT&apos;,10);    //定义每个字的宽度
define(&apos;OFFSET_X&apos;,6);    //左偏移的像素数
define(&apos;OFFSET_Y&apos;,16);    //高偏移的像素数
define(&apos;WORD_SPACING&apos;,4);    //字符间的像素数

class valite
{
    public function setImage($Image)    //打开二维码图片
    {
        $this-&gt;ImagePath = $Image;
    }

    public function getData()
    {
        return $data;
    }

    public function getResult()
    {
        return $DataArray;
    }

    public function getHec()    //除去干扰像素的方法
    {
        $res = imagecreatefromgif($this-&gt;ImagePath);        //创建图像
        $size = getimagesize($this-&gt;ImagePath);    //获取图像长宽
        $data = array();
        for($i = 0; $i &lt; $size[1]; ++$i)    //循环遍历宽度
        {
            for($j = 0; $j &lt; $size[0]; ++$j)    //循环遍历长度
            {
                $rgb = imagecolorat($res,$j,$i);    //取得某像素的颜色索引值
                $rgbarray = imagecolorsforindex($res, $rgb);    // 取出 red，green，blue 和 alpha 的键名的关联数组
                if($rgbarray[&apos;red&apos;] &lt; 160 || $rgbarray[&apos;green&apos;] &lt; 160 || $rgbarray[&apos;blue&apos;] &lt; 160)    //比较 RGB 值
                {
                    $data[$i][$j]=1;    //数字输出1
                }else{
                    $data[$i][$j]=0;    //背景输出0
                }
            }
        }
        $this-&gt;DataArray = $data;    //返回数据
        $this-&gt;ImageSize = $size;
    }

    public function run()    //获取每个像素点的坐标
    {
        $result = &quot;&quot;;
        $data = array(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);

        for($i = 0; $i &lt; 4; ++$i)    //循环,切割四个数字
        {
            $x = ($i * (WORD_WIDTH + WORD_SPACING)) + OFFSET_X;    //计算每个数字的起始水平像素的值 X
            $y = OFFSET_Y;
            for($h = $y; $h &lt; (OFFSET_Y + WORD_HIGHT); ++$h)    //循环获取每个数字的竖直像素值
            {
                for($w = $x; $w &lt; ($x + WORD_WIDTH); ++$w)    //循环获取水平像素值
                {
                    $data[$i] .= $this-&gt;DataArray[$h][$w];    //储存每个数字的二值码
                }
            }
        }


        foreach($data as $numKey =&gt; $numString)    //循环每个数字的二值码
        {
            $max = 0.0;
            $num = 0;
            foreach($this-&gt;Keys as $key =&gt; $value)    //匹配每个的字模二值码
            {
                $percent = 0.0;    //初始相似百分比
                similar_text($value, $numString, $percent);    //计算两个字符串的相似度（以百分比计）
                if(intval($percent) &gt; $max)    //当前相似度与前一次循环的相似度比较，如果比前一次相似度高则
                {
                    $max = $percent;    //储存最大相似度百分比
                    $num = $key;    //储存最大百分比的数字
                    if(intval($percent) &gt; 95)    //将字符串与每一个字模的字符串比较，求其相似度，取最高的相似度对应的数字，或者相似度达到95%以上就可以断定是某个数字
                        break;
                }
            }
            $result .= $num;
        }
        $this-&gt;data = $result;

        return $result;
    }

    public function Draw()    //按顺序取出每个相熟点的值（0/1）
    {
        for($i = 0; $i &lt; $this-&gt;ImageSize[1]; ++$i)
        {
            for($j = 0; $j &lt; $this-&gt;ImageSize[0]; ++$j)
            {
                echo $this-&gt;DataArray[$i][$j];
            }
            echo &quot;\n&quot;;
        }
    }

    public function __construct()    //二值化的每个数字
    {
        $this-&gt;Keys = array(
            &apos;0&apos;=&gt;&apos;00011000001111000110011011000011110000111100001111000011011001100011110000011000&apos;,
            &apos;1&apos;=&gt;&apos;00011000001110000111100000011000000110000001100000011000000110000001100001111110&apos;,
            &apos;2&apos;=&gt;&apos;00111100011001101100001100000011000001100000110000011000001100000110000011111111&apos;,
            &apos;3&apos;=&gt;&apos;01111100110001100000001100000110000111000000011000000011000000111100011001111100&apos;,
            &apos;4&apos;=&gt;&apos;00000110000011100001111000110110011001101100011011111111000001100000011000000110&apos;,
            &apos;5&apos;=&gt;&apos;11111110110000001100000011011100111001100000001100000011110000110110011000111100&apos;,
            &apos;6&apos;=&gt;&apos;00111100011001101100001011000000110111001110011011000011110000110110011000111100&apos;,
            &apos;7&apos;=&gt;&apos;11111111000000110000001100000110000011000001100000110000011000001100000011000000&apos;,
            &apos;8&apos;=&gt;&apos;00111100011001101100001101100110001111000110011011000011110000110110011000111100&apos;,
            &apos;9&apos;=&gt;&apos;00111100011001101100001111000011011001110011101100000011010000110110011000111100&apos;,
        );
    }

    protected $ImagePath;
    protected $DataArray;
    protected $ImageSize;
    protected $data;
    protected $Keys;
    protected $NumStringArray;
}
?&gt;
</code></pre><h2 id="NRC-转-UTF-8编码过程"><a href="#NRC-转-UTF-8编码过程" class="headerlink" title="NRC 转 UTF-8编码过程"></a>NRC 转 UTF-8编码过程</h2><p>UTF-8的编码规则很简单，只有二条： </p>
<p>1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的 unicode 码。因此对于英语字母，UTF-8编码和 ASCII 码是相同的。 </p>
<p>2）对于 n 字节的符号（n&gt;1），第一个字节的前 n 位都设为1，第 n+1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的 unicode 码。 </p>
<p>下表总结了编码规则，字母 x 表示可用编码的位。</p>
<table><tr><td>Unicode 符号范围(十六进制)</td><td>UTF-8编码方式（二进制）</td></tr><br><tr><td>0000 0000-0000 007F</td><td>0xxxxxxx</td></tr><br><tr><td>0000 0080-0000 07FF</td><td>110xxxxx 10xxxxxx</td></tr><br><tr><td>0000 0800-0000 FFFF</td><td>1110xxxx 10xxxxxx 10xxxxxx</td></tr><br><tr><td>0001 0000-0010 FFFF</td><td>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</td></tr></table>

<p>下面，还是以汉字“严”为例，演示如何实现 UTF-8编码。 </p>
<p>已知“严”的 unicode 是4E25（100111000100101），根据上表，可以发现4E25处在第三行的范围内（0000 0800-0000 FFFF），因此“严”的 UTF-8编码需要三个字节，即格式是“1110xxxx 10xxxxxx 10xxxxxx”。然后，从“严”的最后一个二进制位开始，依次从后向前填入格式中的 x，多出的位补0。这样就得到了，“严”的 UTF-8编码是“11100100 10111000 10100101”，转换成十六进制就是 E4B8A5。 </p>
<pre><code>//*-----------------------------------u2utf82gb.php--------------------------------------*//
&lt;?php
function u2utf82gb($c){
    $str=&quot;&quot;;
    if ($c &lt; 0x80) {
        $str.=chr($c);    //当 NRC 编码位于0000 0000-0000 007F 区段时，UTF-8编码转换为0xxxxxxx
    } else if ($c &lt; 0x800) {
        $str.=chr(0xC0 | $c&gt;&gt;6);    //当 NRC 编码位于0000 0080-0000 07FF 区段时，UTF-8编码转换为110xxxxx 10xxxxxx
         $str.=chr(0x80 | $c &amp; 0x3F);
    } else if ($c &lt; 0x10000) {
        $str.=chr(0xE0 | $c&gt;&gt;12);    //当 NRC 编码位于0000 0800-0000 FFFF 区段时，UTF-8编码转换为1110xxxx 10xxxxxx 10xxxxxx
        $str.=chr(0x80 | $c&gt;&gt;6 &amp; 0x3F);
        $str.=chr(0x80 | $c &amp; 0x3F);
    } else if ($c &lt; 0x200000) {
        $str.=chr(0xF0 | $c&gt;&gt;18);    //当 NRC 编码位于0001 0000-0010 FFFF 区段时，UTF-8编码转换为11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
        $str.=chr(0x80 | $c&gt;&gt;12 &amp; 0x3F);
        $str.=chr(0x80 | $c&gt;&gt;6 &amp; 0x3F);
        $str.=chr(0x80 | $c &amp; 0x3F);
    }
        return iconv(&apos;UTF-8&apos;, &apos;GB2312&apos;, $str);
}
?&gt;
</code></pre><h2 id="通过-QR-获取借阅信息"><a href="#通过-QR-获取借阅信息" class="headerlink" title="通过 QR 获取借阅信息"></a>通过 QR 获取借阅信息</h2><p><code>&lt;2014/7/25更新&gt;</code>今天灵（nao）机（can）一动想到一个新想法，能否利用当前借阅最下边的二维码来获取图书的有关信息，于是用手机扫了一下二维码，发现真的可以获取图书的借阅信息。<br><img src="http://picture-lotors.qiniudn.com/lotorsQRcode.jpg" alt="扫描结果" title="扫描结果"><br>于是查看了一下源码，找到了生成二维码的的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;../opac/ajax_qr.php?qrcode=6K%2B76ICF44CQMzEyNTAwMjA3NuOAkeeahOWcqOWAn%2BS5puWIiijpopjlkI0v5bqU6L%2BY5pel5pyfKe%2B8mg0KTHVh56iL5bqP6K6%2B6K6hIDIwMTQtMDktMTQgICAgICAgIA0KUEhQ5a6e5L6L57K%2B6YCaIDIwMTQtMDktMTQgICAgICAgIA0KQXJkdWlub%2BS4gOivleWwseS4iuaJiy4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%2FnlLvlhaXpl6jovbvmnb7lraYs56u55a2QLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBbmRyb2lk54Ot6Zeo5bqU55So5byA5Y%2BR6K%2Bm6KejLi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%2FnlLvlhaXpl6jovbvmnb7lraYs6I2J5pys6Iqx5Y2JLi4gMjAxNC0wOS0xNCAgICAgICAgDQrlkI3lrrblm73nlLvor77loIIu6Iqx6bif56%2BHLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBcmR1aW5v5oqA5pyv5YaF5bmVIDIwMTQtMDktMTQgICAgICAgIA0K55av54uCQW5kcm9pZOiusuS5iS4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQpqUXVlcnnlvIDlj5HmioDmnK%2For6bop6MuLiAyMDE0LTA5LTE0ICAgICAgICANCg%3D%3D&quot; border=&quot;0&quot; /&gt;&lt;/a&gt;&lt;/span&gt;</span><br></pre></td></tr></table></figure>
<p>这个二维码是由<code>http://210.34.85.114:8080/opac/ajax_qr.php</code>这个服务器生成的，后面的 qrcode 应该是 GB2312转 UTF-8后 url 编码产生，这里不去管它。<br>由于直接利用 PHP 无法解析二维码，所以调用<code>http://zxing.org/w/decode.jspx</code>这一个网页服务来对二维码解析。<br>用 Fidder 分析数据发送，该页面是通过_GET 方法<code>http://zxing.org/w/decode?u=</code>后接查询图片的 url 来传递数据，这里的 url 是<code>http://210.34.85.114:8080/opac/ajax_qr.php</code>这个服务器生成的二维码的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET http://zxing.org/w/decode?u=http%3A%2F%2F210.34.85.114%3A8080%2Fopac%2Fajax_qr.php%3Fqrcode%3D6K%252B76ICF44CQMzEyNTAwMjA3NuOAkeeahOWcqOWAn%252BS5puWIiijpopjlkI0v5bqU6L%252BY5pel5pyfKe%252B8mg0KTHVh56iL5bqP6K6%252B6K6hIDIwMTQtMDktMTQgICAgICAgIA0KUEhQ5a6e5L6L57K%252B6YCaIDIwMTQtMDktMTQgICAgICAgIA0KQXJkdWlub%252BS4gOivleWwseS4iuaJiy4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%252FnlLvlhaXpl6jovbvmnb7lraYs56u55a2QLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBbmRyb2lk54Ot6Zeo5bqU55So5byA5Y%252BR6K%252Bm6KejLi4gMjAxNC0wOS0xNCAgICAgICAgDQrkuK3lm73lhpnmhI%252FnlLvlhaXpl6jovbvmnb7lraYs6I2J5pys6Iqx5Y2JLi4gMjAxNC0wOS0xNCAgICAgICAgDQrlkI3lrrblm73nlLvor77loIIu6Iqx6bif56%252BHLi4gMjAxNC0wOS0xNCAgICAgICAgDQpBcmR1aW5v5oqA5pyv5YaF5bmVIDIwMTQtMDktMTQgICAgICAgIA0K55av54uCQW5kcm9pZOiusuS5iS4y54mILi4gMjAxNC0wOS0xNCAgICAgICAgDQpqUXVlcnnlvIDlj5HmioDmnK%252For6bop6MuLiAyMDE0LTA5LTE0ICAgICAgICANCg%253D%253D HTTP/1.1</span><br><span class="line">Host: zxing.org</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1883.0 Safari/537.36</span><br><span class="line">Referer: http://zxing.org/w/decode.jspx</span><br><span class="line">Accept-Encoding: gzip,deflate,sdch</span><br><span class="line">Accept-Language: en-US,en;q=0.8,zh-CN;q=0.6,zh;q=0.4</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">//*-----------------------------------qrcode.php--------------------------------------*//</span><br><span class="line">&lt;?php</span><br><span class="line">	function qrcode($src)&#123;	</span><br><span class="line">		//切割 html 字符串获取图片 url	</span><br><span class="line">		preg_match_all(&apos;/&lt;img\ssrc=\&quot;[^\&quot;]+\&quot;/&apos;,$src,$qr);</span><br><span class="line">		//截取的&quot;&quot;中间的 url</span><br><span class="line">		preg_match_all(&apos;/\&quot;[^\&quot;]+/&apos;,$qr[0][0],$qrcode);</span><br><span class="line">		//除去开头的 ..</span><br><span class="line">		$qrcode = preg_replace(&apos;/\.\./&apos;,&apos;&apos;,$qrcode[0][0]);</span><br><span class="line">		//除去开头的 &quot;</span><br><span class="line">		$qrcode = preg_replace(&apos;/\&quot;/&apos;,&apos;&apos;,$qrcode);</span><br><span class="line">		//拼接 url</span><br><span class="line">		$qrcode = &apos;http://210.34.85.114:8080&apos;.$qrcode;</span><br><span class="line">		//url 编码</span><br><span class="line">		$qrcode = urlencode($qrcode);</span><br><span class="line">		//拼接查询 url</span><br><span class="line">		$url = &apos;http://zxing.org/w/decode?u=&apos;.$qrcode;</span><br><span class="line">		//获取数据</span><br><span class="line">		$curl = curl_init($url);</span><br><span class="line">		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">		$infomation = curl_exec($curl);</span><br><span class="line">		curl_close($curl);</span><br><span class="line">		</span><br><span class="line">		//获取 QRcode 信息</span><br><span class="line">		preg_match_all(&apos;/读者[^&lt;]+/&apos;,$infomation,$info);</span><br><span class="line">		//UTF-8转 GB2312</span><br><span class="line">		$info = iconv(&apos;UTF-8&apos;,&apos;GB2312&apos;,$info[0][0]);</span><br><span class="line">		print_r($info);</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
  </div>
</article>
<div class="blog-post-comments">
	<div class="wildfire_thread"></div>
</div>
    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/fjkfwz">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Fidder2解析图书馆登入系统过程"><span class="toc-number">1.</span> <span class="toc-text"><a href="#Fidder2&#x89E3;&#x6790;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;" class="headerlink" title="Fidder2&#x89E3;&#x6790;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;"></a>Fidder2&#x89E3;&#x6790;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Fidder2介绍"><span class="toc-number">1.1.</span> <span class="toc-text"><a href="#Fidder2&#x4ECB;&#x7ECD;" class="headerlink" title="Fidder2&#x4ECB;&#x7ECD;"></a>Fidder2&#x4ECB;&#x7ECD;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过-Fidder-查看图书馆登入过程"><span class="toc-number">1.2.</span> <span class="toc-text"><a href="#&#x901A;&#x8FC7;-Fidder-&#x67E5;&#x770B;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x901A;&#x8FC7; Fidder &#x67E5;&#x770B;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x8FC7;&#x7A0B;"></a>&#x901A;&#x8FC7; Fidder &#x67E5;&#x770B;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x8FC7;&#x7A0B;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模拟图书馆登入系统过程"><span class="toc-number">2.</span> <span class="toc-text"><a href="#&#x6A21;&#x62DF;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x6A21;&#x62DF;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;"></a>&#x6A21;&#x62DF;&#x56FE;&#x4E66;&#x9986;&#x767B;&#x5165;&#x7CFB;&#x7EDF;&#x8FC7;&#x7A0B;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#机器识别验证码"><span class="toc-number">2.1.</span> <span class="toc-text"><a href="#&#x673A;&#x5668;&#x8BC6;&#x522B;&#x9A8C;&#x8BC1;&#x7801;" class="headerlink" title="&#x673A;&#x5668;&#x8BC6;&#x522B;&#x9A8C;&#x8BC1;&#x7801;"></a>&#x673A;&#x5668;&#x8BC6;&#x522B;&#x9A8C;&#x8BC1;&#x7801;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NRC-转-UTF-8编码过程"><span class="toc-number">2.2.</span> <span class="toc-text"><a href="#NRC-&#x8F6C;-UTF-8&#x7F16;&#x7801;&#x8FC7;&#x7A0B;" class="headerlink" title="NRC &#x8F6C; UTF-8&#x7F16;&#x7801;&#x8FC7;&#x7A0B;"></a>NRC &#x8F6C; UTF-8&#x7F16;&#x7801;&#x8FC7;&#x7A0B;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过-QR-获取借阅信息"><span class="toc-number">2.3.</span> <span class="toc-text"><a href="#&#x901A;&#x8FC7;-QR-&#x83B7;&#x53D6;&#x501F;&#x9605;&#x4FE1;&#x606F;" class="headerlink" title="&#x901A;&#x8FC7; QR &#x83B7;&#x53D6;&#x501F;&#x9605;&#x4FE1;&#x606F;"></a>&#x901A;&#x8FC7; QR &#x83B7;&#x53D6;&#x501F;&#x9605;&#x4FE1;&#x606F;</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&text=微信公众平台图书馆查询开发记录"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&is_video=false&description=微信公众平台图书馆查询开发记录"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=微信公众平台图书馆查询开发记录&body=Check out this article: https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&title=微信公众平台图书馆查询开发记录"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://fjkfwz.github.io/2014/07/25/Weixin-Library-BookSearch/&name=微信公众平台图书馆查询开发记录&description=&lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;：这篇文章记录图书馆查询微信公众平台开发全过程，主要内容包括：（1）Fidder2解析图书馆登入系统过程（2）模拟图书馆登入系统过程（3）机器识别验证码（4）Unicode 转 UTF-8 编码过程（5）微信公众账号的绑定（6）Memcache 缓存技术(7)正则表达式&lt;br&gt;"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>
    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast')"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>
    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 masukio
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/fjkfwz">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


<script>
  // 你可以自定义一些配置
  //
  // databaseProvider: 必须为 'wilddog' 或者 'firebase'
  // databaseConfig: 请从你的数据库控制台复制过来。
  // pageURL(可选): 默认为当前页面的 URL。
  // pageTitle(可选): 默认为当前页面的 title。
  // theme(可选): 'light'（默认）或者 'dark'。
  // locale(可选): 'en'（默认）或者 'zh-CN'
  // defaultAvatarURL(可选): 默认头像是一个可爱的消防员 :-D
  var wildfireConfig = () => ({
    databaseProvider: 'wilddog',
    databaseConfig: {
        siteId: "wd2882084211dpgrir"
    },
    theme: 'dark',
    locale: 'zh-CN',
    defaultAvatarURL: 'https://image.flaticon.com/icons/svg/621/621863.svg'
  })
</script>
<script src="https://unpkg.com/wildfire/dist/wildfire.auto.js"></script>